{% extends "base.html" %}
{% load static %}

{% block title %}Channel Manager{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb breadcrumb-soul mb-0">
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">Channel Manager</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="channel-manager-page">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
    <div>
      <h1 class="mb-1" style="background: var(--soul-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
        Channel Manager
      </h1>
      <p class="text-muted mb-0">Manage Telegram channels for automated ads. Set a default channel; test connection to verify bot admin rights.</p>
    </div>
  </div>

  <!-- Add New Channel -->
  <div class="card card-soul mb-4" style="background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color, var(--border-subtle));">
    <div class="card-header custom-card-header" style="background: var(--bg-card); color: var(--text-primary); border-bottom: 1px solid var(--border-color, var(--border-subtle));">
      <i class="fa-solid fa-plus me-2" aria-hidden="true"></i> Add New Channel
    </div>
    <div class="card-body">
      <form method="post" action="{% url 'channel_list' %}" class="channel-form">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-4">
            <label for="id_title" class="form-label">Title</label>
            <input type="text" name="title" id="id_title" class="form-control" placeholder="e.g. Live Ads Channel" value="{{ form.title.value|default:'' }}" maxlength="128" required>
            {% if form.title.errors %}<div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>{% endif %}
          </div>
          <div class="col-md-4">
            <label for="id_channel_id" class="form-label">Channel ID</label>
            <input type="text" name="channel_id" id="id_channel_id" class="form-control" placeholder="-1001234567890" value="{{ form.channel_id.value|default:'' }}" maxlength="32" required>
            {% if form.channel_id.errors %}<div class="invalid-feedback d-block">{{ form.channel_id.errors.0 }}</div>{% endif %}
          </div>
          <div class="col-md-4">
            <label for="id_bot_connection" class="form-label">Bot</label>
            {{ form.bot_connection }}
            {% if form.bot_connection.errors %}<div class="invalid-feedback d-block">{{ form.bot_connection.errors.0 }}</div>{% endif %}
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary" style="background: var(--primary-color); border-color: var(--primary-color);">
            <i class="fa-solid fa-plus me-1" aria-hidden="true"></i> Add Channel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Channel cards -->
  <div class="row g-4">
    {% for ch in channels %}
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card card-soul h-100" style="background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color, var(--border-subtle));">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title mb-0" style="color: var(--text-primary);">{{ ch.title }}</h5>
            {% if ch.is_default %}
            <span class="badge rounded-pill" style="background: var(--success-color); color: #fff;">Default</span>
            {% endif %}
          </div>
          <p class="card-text small text-muted mb-3">
            <code style="color: var(--text-secondary);">{{ ch.channel_id }}</code>
          </p>
          <p class="small mb-3" style="color: var(--text-secondary);">
            Bot: <strong>@{{ ch.bot_connection.username|default:"—" }}</strong>
          </p>
          <div class="d-flex flex-wrap gap-2">
            {% if not ch.is_default %}
            <form method="post" action="{% url 'channel_set_default' ch.pk %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-primary" style="background: var(--primary-color); border-color: var(--primary-color);">
                <i class="fa-solid fa-star me-1" aria-hidden="true"></i> Set as Default
              </button>
            </form>
            {% endif %}
            <form method="post" action="{% url 'channel_test_connection' ch.pk %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-primary" style="border-color: var(--primary-color); color: var(--primary-color);">
                <i class="fa-solid fa-paper-plane me-1" aria-hidden="true"></i> Test Connection
              </button>
            </form>
            <form method="post" action="{% url 'channel_delete' ch.pk %}" class="d-inline" onsubmit="return confirm('Delete channel “{{ ch.title }}”?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm channel-delete-btn">
                <i class="fa-solid fa-trash me-1" aria-hidden="true"></i> Delete
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="card card-soul text-center py-5" style="background: var(--bg-card); color: var(--text-primary);">
        <p class="text-muted mb-0">No channels yet. Add one above to get started.</p>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .channel-manager-page .channel-delete-btn {
    border-color: var(--border-color, #cbd5e1);
    color: var(--text-secondary, #94a3b8);
  }
  .channel-manager-page .channel-delete-btn:hover {
    border-color: #dc2626;
    color: #dc2626;
    background: rgba(220, 38, 38, 0.06);
  }
  body:not(.theme-light) .channel-manager-page .channel-delete-btn:hover {
    color: #f87171;
    border-color: rgba(220, 38, 38, 0.6);
  }
</style>
{% endblock %}
