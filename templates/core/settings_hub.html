{% extends "base.html" %}
{% load static %}

{% block title %}Control Panel — Settings{% endblock %}

{% block extra_css %}
<style>
.settings-hub {
  background: var(--bg-body);
  color: var(--text-primary);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}
.settings-hub .nav-pills .nav-link {
  border-radius: 8px;
  padding: 0.75rem 1rem;
  color: var(--text-secondary);
  font-weight: 500;
  border: none;
  margin-bottom: 0.25rem;
}
.settings-hub .nav-pills .nav-link:hover { color: var(--text-primary); background: rgba(59, 130, 246, 0.08); }
.settings-hub .nav-pills .nav-link.active {
  background: var(--primary-color);
  color: #fff;
  font-weight: 600;
}
.theme-light .settings-hub .nav-pills .nav-link.active { background: var(--primary-color); color: #fff; }
.settings-hub .tab-pane-card {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-shadow: var(--shadow-sm);
  padding: 1.5rem;
  margin-bottom: 1.25rem;
}
.settings-hub .tab-pane-card h5 {
  color: var(--text-primary);
  font-weight: 600;
  border-bottom: 1px solid var(--border-color);
  padding-bottom: 0.5rem;
  margin-bottom: 1rem;
}
.settings-hub .form-control, .settings-hub .form-select {
  border: 1px solid var(--border-color);
  border-radius: 8px;
}
.settings-hub .form-control:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  outline: none;
}
.settings-hub .toast-success {
  position: fixed; top: 1rem; right: 1rem; z-index: 1100;
  background: var(--success-color); color: #fff; padding: 0.75rem 1.25rem; border-radius: 8px;
  font-weight: 500; box-shadow: var(--shadow-sm);
}
.settings-hub .token-masked { font-family: monospace; letter-spacing: 0.1em; }
.settings-hub .channel-delete-btn { border-color: var(--border-color); color: var(--text-secondary); }
.settings-hub .channel-delete-btn:hover { border-color: #dc2626; color: #dc2626; background: rgba(220, 38, 38, 0.06); }
</style>
{% endblock %}

{% block content %}
<div class="settings-hub">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
    <div>
      <h1 class="mb-1" style="color: var(--text-primary); font-weight: 600;">Control Panel</h1>
      <p class="text-muted mb-0">Site configuration, integrations, team, and appearance.</p>
    </div>
    <button type="button" class="theme-switcher-btn border rounded p-2" id="themeSwitcherSettings" title="Toggle theme" aria-label="Toggle light/dark theme" data-theme-toggle>
      <i class="fa-solid fa-sun icon theme-icon-light" aria-hidden="true" style="display: {% if theme_preference == 'dark' %}inline-block{% else %}none{% endif %};"></i>
      <i class="fa-solid fa-moon icon theme-icon-dark" aria-hidden="true" style="display: {% if theme_preference == 'light' %}inline-block{% else %}none{% endif %};"></i>
    </button>
  </div>

  <div class="row g-4">
    <div class="col-md-3 col-lg-2">
      <nav class="nav flex-column nav-pills">
        <a class="nav-link {% if active_tab == 'general' %}active{% endif %}" href="?tab=general">General</a>
        <a class="nav-link {% if active_tab == 'api' %}active{% endif %}" href="?tab=api">API & Integrations</a>
        <a class="nav-link {% if active_tab == 'delivery' %}active{% endif %}" href="?tab=delivery">Delivery</a>
        <a class="nav-link {% if active_tab == 'team' %}active{% endif %}" href="?tab=team">Team & Security</a>
        <a class="nav-link {% if active_tab == 'channels' %}active{% endif %}" href="?tab=channels">Channel Manager</a>
        <a class="nav-link {% if active_tab == 'appearance' %}active{% endif %}" href="?tab=appearance">Appearance</a>
      </nav>
    </div>
    <div class="col-md-9 col-lg-10">
      {% if messages %}
      {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
      {% endif %}
      <div id="settingsToast" class="toast-success d-none"></div>

      <!-- 1. General -->
      <div class="tab-pane-content {% if active_tab != 'general' %}d-none{% endif %}" data-tab="general">
        <form id="settingsFormGeneral" class="settings-form">
          {% csrf_token %}
          <div class="tab-pane-card">
            <h5>Site & Webhook</h5>
            <p class="text-muted small mb-3">Production URL for Telegram webhook. Use HTTPS only.</p>
            <div class="mb-3">
              <label class="form-label">Production base URL</label>
              <input type="url" class="form-control" name="production_base_url" value="{{ config.production_base_url|default:'' }}" placeholder="https://iraniu.ir">
            </div>
          </div>
          <div class="tab-pane-card">
            <h5>AI (OpenAI)</h5>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" name="is_ai_enabled" id="is_ai_enabled" {% if config.is_ai_enabled %}checked{% endif %}>
              <label class="form-check-label" for="is_ai_enabled">Enable AI content moderation</label>
            </div>
            <div class="mb-3">
              <label class="form-label">OpenAI API Key</label>
              <div class="input-group">
                <input type="password" class="form-control" name="openai_api_key" id="openai_api_key" value="{{ config.openai_api_key }}" placeholder="sk-...">
                <button type="button" class="input-group-text toggle-password" data-target="openai_api_key" title="Show/hide"><i class="fa-regular fa-eye icon"></i></button>
              </div>
              <small class="text-muted">Stored securely. Leave blank to keep current.</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Model</label>
              <input type="text" class="form-control" name="openai_model" value="{{ config.openai_model }}" placeholder="gpt-3.5-turbo or gpt-4o">
            </div>
            <div class="mb-3">
              <label class="form-label">System prompt</label>
              <textarea class="form-control" name="ai_system_prompt" rows="4">{{ config.ai_system_prompt }}</textarea>
            </div>
            <button type="button" class="btn btn-action test-connection-btn" id="testOpenAI">
              <span class="spinner-border spinner-border-sm d-none" role="status"></span>
              <i class="fa-solid fa-check checkmark icon d-none"></i>
              <span class="btn-text">Test OpenAI</span>
            </button>
            <span id="testOpenAIResult" class="small ms-2"></span>
          </div>
          <div class="tab-pane-card">
            <h5>Message templates</h5>
            <p class="text-muted small mb-3">Used when sending approval/rejection and submission ack.</p>
            <div class="mb-3">
              <label class="form-label">Submission ack</label>
              <textarea class="form-control" name="submission_ack_message" rows="2">{{ config.submission_ack_message }}</textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Approval message</label>
              <textarea class="form-control" name="approval_message_template" rows="2">{{ config.approval_message_template }}</textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Rejection message</label>
              <textarea class="form-control" name="rejection_message_template" rows="2">{{ config.rejection_message_template }}</textarea>
            </div>
          </div>
          <div class="tab-pane-card">
            <h5>Maintenance</h5>
            <div class="d-flex gap-2 flex-wrap">
              <a href="{% url 'export_config' %}" class="btn btn-action" target="_blank">Export config</a>
              <button type="button" class="btn btn-soul" id="importConfigBtn">Import from JSON</button>
            </div>
            <div class="mt-3 d-none" id="importArea">
              <textarea id="importJson" class="form-control font-monospace small" rows="6" placeholder='{"is_ai_enabled": false, ...}'></textarea>
              <button type="button" class="btn btn-action mt-2" id="doImport">Apply import</button>
            </div>
          </div>
          <button type="submit" class="btn btn-soul">Save General Settings</button>
        </form>
      </div>

      <!-- 2. API & Integrations -->
      <div class="tab-pane-content {% if active_tab != 'api' %}d-none{% endif %}" data-tab="api">
        <div class="tab-pane-card">
          <h5>Instagram (Site fallback)</h5>
          <p class="text-muted small mb-3">Fallback for Post to Feed/Story. Prefer <a href="{% url 'settings_instagram' %}">Instagram configs</a> if set.</p>
          <div class="mb-3">
            <label class="form-label">Instagram Business ID</label>
            <input type="text" class="form-control" form="settingsFormGeneral" name="instagram_business_id" value="{{ config.instagram_business_id|default:'' }}" placeholder="IG user ID">
          </div>
          <div class="mb-3">
            <label class="form-label">Facebook Access Token</label>
            <div class="input-group">
              <input type="password" class="form-control" id="facebook_access_token" form="settingsFormGeneral" name="facebook_access_token" placeholder="Leave blank to keep current">
              <button type="button" class="input-group-text toggle-password" data-target="facebook_access_token" title="Show/hide"><i class="fa-regular fa-eye icon"></i></button>
            </div>
            <small class="text-muted">Save from the General tab. Stored encrypted.</small>
          </div>
        </div>
        <div class="tab-pane-card">
          <h5>Telegram Bots</h5>
          <p class="text-muted small mb-3">Manage production & dev bots in <a href="{% url 'bot_list' %}">Bots</a>. Test connection below with a token (not saved here).</p>
          <div class="mb-3">
            <label class="form-label">Test token</label>
            <div class="input-group">
              <input type="password" class="form-control" id="test_telegram_token" placeholder="Paste bot token to test">
              <button type="button" class="input-group-text toggle-password" data-target="test_telegram_token"><i class="fa-regular fa-eye icon"></i></button>
            </div>
            <button type="button" class="btn btn-action mt-2" id="testTelegramBtn">Test Telegram</button>
            <span id="testTelegramResult" class="small ms-2"></span>
          </div>
        </div>
        <div class="tab-pane-card">
          <h5>API clients</h5>
          <p class="text-muted small mb-3">Create and manage API keys for external integrations.</p>
          <a href="{% url 'settings_api' %}" class="btn btn-soul">Manage API clients</a>
          <ul class="list-unstyled mt-2 mb-0">
            {% for c in api_clients %}
            <li class="py-1"><code>{{ c.name }}</code> {% if c.is_active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}</li>
            {% empty %}
            <li class="text-muted">No API clients. Create one via the link above.</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- 3. Delivery -->
      <div class="tab-pane-content {% if active_tab != 'delivery' %}d-none{% endif %}" data-tab="delivery">
        <div class="tab-pane-card">
          <h5>Recent delivery logs</h5>
          <form method="get" class="mb-3 d-flex gap-2 flex-wrap align-items-end">
            <input type="hidden" name="tab" value="delivery">
            <div>
              <label class="form-label small mb-0">Channel</label>
              <select name="delivery_channel" class="form-select form-select-sm" style="width:auto">
                <option value="">All</option>
                {% for v, l in channel_choices %}<option value="{{ v }}" {% if delivery_filters.channel == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
              </select>
            </div>
            <div>
              <label class="form-label small mb-0">Status</label>
              <select name="delivery_status" class="form-select form-select-sm" style="width:auto">
                <option value="">All</option>
                {% for v, l in status_choices %}<option value="{{ v }}" {% if delivery_filters.status == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
              </select>
            </div>
            <button type="submit" class="btn btn-sm btn-soul">Filter</button>
          </form>
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Ad</th>
                  <th>Channel</th>
                  <th>Status</th>
                  <th>Error</th>
                  <th>Created</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for log in delivery_logs %}
                <tr>
                  <td><a href="{% url 'ad_detail' log.ad.uuid %}">{{ log.ad.uuid|truncatechars:10 }}</a></td>
                  <td>{{ log.get_channel_display }}</td>
                  <td>
                    {% if log.status == 'success' %}<span class="badge bg-success">Success</span>
                    {% elif log.status == 'failed' %}<span class="badge bg-danger">Failed</span>
                    {% else %}<span class="badge bg-secondary">Pending</span>{% endif %}
                  </td>
                  <td class="text-muted small">{{ log.error_message|truncatewords:5|default:"—" }}</td>
                  <td>{{ log.created_at|timesince }} ago</td>
                  <td>
                    {% if log.status == 'failed' %}
                    <button type="button" class="btn btn-sm btn-outline-warning delivery-retry-btn" data-pk="{{ log.pk }}" data-url="{% url 'delivery_retry' log.pk %}">Retry</button>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-muted">No delivery logs.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <p class="small text-muted mt-2 mb-0">Showing up to 25 recent logs. Delivery runs on approval; retry failed items above.</p>
        </div>
      </div>

      <!-- 4. Team & Security -->
      <div class="tab-pane-content {% if active_tab != 'team' %}d-none{% endif %}" data-tab="team">
        {% if user.is_superuser %}
        <div class="tab-pane-card">
          <h5>Staff & Admins</h5>
          <a href="{% url 'admin_management_create' %}" class="btn btn-soul mb-3"><i class="fa-solid fa-user-plus icon me-1"></i> Add New Admin</a>
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Nickname</th>
                  <th>Telegram ID</th>
                  <th>Notifications</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for admin in admins %}
                <tr>
                  <td>{{ admin.user.username }}</td>
                  <td>{{ admin.admin_nickname|default:"—" }}</td>
                  <td><code>{{ admin.telegram_id|default:"—" }}</code></td>
                  <td><span class="badge {% if admin.is_notified %}bg-success{% else %}bg-secondary{% endif %}">{{ admin.is_notified|yesno:"On,Off" }}</span></td>
                  <td>
                    {% if admin.telegram_id %}
                    <form method="post" action="{% url 'admin_test_notification' admin.pk %}" class="d-inline me-1" data-test-notification>{% csrf_token %}<button type="submit" class="btn btn-sm btn-outline-primary">Test</button></form>
                    {% endif %}
                    <a href="{% url 'admin_management_edit' admin.pk %}" class="btn btn-sm btn-action">Edit</a>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-muted">No admins yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        {% endif %}
        <div class="tab-pane-card">
          <h5>Change my password</h5>
          <form id="changePasswordForm" class="mb-0">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Current password</label>
              <input type="password" class="form-control" name="old_password" required autocomplete="current-password">
            </div>
            <div class="mb-3">
              <label class="form-label">New password</label>
              <input type="password" class="form-control" name="new_password1" required autocomplete="new-password">
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm new password</label>
              <input type="password" class="form-control" name="new_password2" required autocomplete="new-password">
            </div>
            <button type="submit" class="btn btn-soul">Change password</button>
          </form>
        </div>
      </div>

      <!-- 5. Channel Manager -->
      <div class="tab-pane-content {% if active_tab != 'channels' %}d-none{% endif %}" data-tab="channels">
        <div class="tab-pane-card">
          <h5><i class="fa-solid fa-plus me-2"></i> Add New Channel</h5>
          <form method="post" action="{% url 'channel_list' %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{% url 'settings' %}?tab=channels">
            <div class="row g-3">
              <div class="col-md-4">
                <label for="id_title" class="form-label">Title</label>
                <input type="text" name="title" id="id_title" class="form-control" placeholder="e.g. Live Ads Channel" value="{{ channel_form.title.value|default:'' }}" maxlength="128" required>
              </div>
              <div class="col-md-4">
                <label for="id_channel_id" class="form-label">Channel ID</label>
                <input type="text" name="channel_id" id="id_channel_id" class="form-control" placeholder="-1001234567890" value="{{ channel_form.channel_id.value|default:'' }}" maxlength="32" required>
              </div>
              <div class="col-md-4">
                <label for="id_bot_connection" class="form-label">Bot</label>
                {{ channel_form.bot_connection }}
              </div>
            </div>
            <button type="submit" class="btn btn-soul mt-3">Add Channel</button>
          </form>
        </div>
        <div class="tab-pane-card">
          <h5>Channels</h5>
          <div class="row g-3">
            {% for ch in channels %}
            <div class="col-12 col-md-6">
              <div class="border rounded p-3" style="border-color: var(--border-color) !important;">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <strong style="color: var(--text-primary);">{{ ch.title }}</strong>
                  {% if ch.is_default %}<span class="badge rounded-pill" style="background: var(--success-color); color: #fff;">Default</span>{% endif %}
                </div>
                <p class="small text-muted mb-2"><code>{{ ch.channel_id }}</code> · Bot: @{{ ch.bot_connection.username|default:"—" }}</p>
                <div class="d-flex flex-wrap gap-2">
                  {% if not ch.is_default %}
                  <form method="post" action="{% url 'channel_set_default' ch.pk %}">{% csrf_token %}<button type="submit" class="btn btn-sm btn-primary">Set default</button></form>
                  {% endif %}
                  <form method="post" action="{% url 'channel_test_connection' ch.pk %}">{% csrf_token %}<button type="submit" class="btn btn-sm btn-outline-primary">Test</button></form>
                  <form method="post" action="{% url 'channel_delete' ch.pk %}" onsubmit="return confirm('Delete {{ ch.title }}?');">{% csrf_token %}<button type="submit" class="btn btn-sm channel-delete-btn">Delete</button></form>
                </div>
              </div>
            </div>
            {% empty %}
            <p class="text-muted mb-0">No channels. Add one above.</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- 6. Appearance -->
      <div class="tab-pane-content {% if active_tab != 'appearance' %}d-none{% endif %}" data-tab="appearance">
        <div class="tab-pane-card">
          <h5>Theme</h5>
          <p class="text-muted small mb-3">Choose a theme that is easy on your eyes. Changes apply immediately.</p>
          <div class="d-flex align-items-center gap-3 flex-wrap">
            <div class="d-flex align-items-center gap-2">
              <span class="fw-semibold" style="color: var(--text-primary);">Light</span>
              <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="themeSwitchAppearance" {% if theme_preference == 'dark' %}checked{% endif %} title="Dark theme when on">
                <label class="form-check-label" for="themeSwitchAppearance">Dark</label>
              </div>
            </div>
            <button type="button" class="theme-switcher-btn btn btn-outline-primary" data-theme-toggle>
              <i class="fa-solid fa-sun icon theme-icon-light" style="display: {% if theme_preference == 'dark' %}inline-block{% else %}none{% endif %};"></i>
              <i class="fa-solid fa-moon icon theme-icon-dark" style="display: {% if theme_preference == 'light' %}inline-block{% else %}none{% endif %};"></i>
              <span class="ms-1">Switch theme now</span>
            </button>
          </div>
          <p class="small text-muted mt-2 mb-0">Light: soft blue-grey palette. Dark: midnight obsidian. Your choice is saved for next visit.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  var csrf = document.querySelector('[name=csrfmiddlewaretoken]') && document.querySelector('[name=csrfmiddlewaretoken]').value;
  function showToast(msg) {
    var el = document.getElementById('settingsToast');
    if (!el) return;
    el.textContent = msg;
    el.classList.remove('d-none');
    setTimeout(function() { el.classList.add('d-none'); }, 3500);
  }

  document.querySelectorAll('.toggle-password').forEach(function(btn) {
    var targetId = btn.getAttribute('data-target');
    if (!targetId) return;
    btn.addEventListener('click', function() {
      var input = document.getElementById(targetId) || document.querySelector('[name="' + targetId + '"]');
      if (!input) return;
      var isPass = input.type === 'password';
      input.type = isPass ? 'text' : 'password';
      var icon = btn.querySelector('i');
      if (icon) icon.className = (isPass ? 'fa-regular fa-eye-slash' : 'fa-regular fa-eye') + ' icon';
    });
  });

  var formGeneral = document.getElementById('settingsFormGeneral');
  if (formGeneral) {
    formGeneral.addEventListener('submit', function(e) {
      e.preventDefault();
      var fd = new FormData(formGeneral);
      fetch('{% url "settings_save" %}', { method: 'POST', body: fd, headers: { 'X-CSRFToken': csrf } })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d.status === 'success') showToast('Settings saved.');
          else showToast(d.message || 'Error');
        })
        .catch(function() { showToast('Request failed.'); });
    });
  }

  var testOpenAI = document.getElementById('testOpenAI');
  if (testOpenAI) {
    testOpenAI.addEventListener('click', function() {
      var key = (document.getElementById('openai_api_key') || {}).value;
      var resultEl = document.getElementById('testOpenAIResult');
      testOpenAI.querySelector('.spinner-border').classList.remove('d-none');
      testOpenAI.querySelector('.btn-text').classList.add('d-none');
      resultEl.textContent = '';
      fetch('{% url "test_openai" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrf },
        body: 'openai_api_key=' + encodeURIComponent(key)
      })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          testOpenAI.querySelector('.spinner-border').classList.add('d-none');
          testOpenAI.querySelector('.btn-text').classList.remove('d-none');
          resultEl.className = 'small ms-2 ' + (d.success ? 'text-success' : 'text-danger');
          resultEl.textContent = d.message || (d.success ? 'OK' : 'Failed');
        })
        .catch(function() {
          testOpenAI.querySelector('.spinner-border').classList.add('d-none');
          testOpenAI.querySelector('.btn-text').classList.remove('d-none');
          resultEl.className = 'small ms-2 text-danger';
          resultEl.textContent = 'Request failed';
        });
    });
  }

  var testTelegramBtn = document.getElementById('testTelegramBtn');
  if (testTelegramBtn) {
    testTelegramBtn.addEventListener('click', function() {
      var token = (document.getElementById('test_telegram_token') || {}).value;
      var resultEl = document.getElementById('testTelegramResult');
      resultEl.textContent = 'Testing...';
      resultEl.className = 'small ms-2';
      fetch('{% url "test_telegram" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrf },
        body: 'telegram_bot_token=' + encodeURIComponent(token)
      })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          resultEl.className = 'small ms-2 ' + (d.success ? 'text-success' : 'text-danger');
          resultEl.textContent = d.message || (d.success ? 'OK' : 'Failed');
        })
        .catch(function() { resultEl.className = 'small ms-2 text-danger'; resultEl.textContent = 'Request failed'; });
    });
  }

  document.getElementById('importConfigBtn') && document.getElementById('importConfigBtn').addEventListener('click', function() {
    document.getElementById('importArea').classList.toggle('d-none');
  });
  document.getElementById('doImport') && document.getElementById('doImport').addEventListener('click', function() {
    var raw = (document.getElementById('importJson') || {}).value.trim();
    if (!raw) { alert('Paste JSON first.'); return; }
    fetch('{% url "import_config" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
      body: raw
    })
      .then(function(r) { return r.json(); })
      .then(function(res) {
        if (res.status === 'success') { showToast('Import applied.'); setTimeout(function() { location.reload(); }, 800); }
        else showToast(res.message || 'Error');
      })
      .catch(function() { showToast('Request failed'); });
  });

  document.querySelectorAll('.delivery-retry-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var url = btn.getAttribute('data-url');
      var fd = new FormData();
      fd.append('csrfmiddlewaretoken', csrf);
      fetch(url, { method: 'POST', body: fd, headers: { 'X-CSRFToken': csrf } })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d.status === 'success') { showToast('Retry sent.'); btn.closest('tr').querySelector('td:nth-child(3)').innerHTML = d.delivery_ok ? '<span class="badge bg-success">Success</span>' : '<span class="badge bg-danger">Failed</span>'; btn.remove(); }
          else showToast(d.message || 'Error');
        })
        .catch(function() { showToast('Request failed'); });
    });
  });

  document.querySelectorAll('form[data-test-notification]').forEach(function(form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var btn = form.querySelector('button[type="submit"]');
      var orig = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
      var fd = new FormData(form);
      fetch(form.action, { method: 'POST', body: fd, headers: { 'X-CSRFToken': csrf } })
        .then(function(r) { return r.json().catch(function() { return {}; }); })
        .then(function(d) {
          if (d.success) showToast('Test notification sent.');
          else showToast(d.message || 'Failed');
        })
        .catch(function() { showToast('Request failed'); })
        .finally(function() { btn.disabled = false; btn.innerHTML = orig; });
    });
  });

  var changePasswordForm = document.getElementById('changePasswordForm');
  if (changePasswordForm) {
    changePasswordForm.addEventListener('submit', function(e) {
      e.preventDefault();
      var fd = new FormData(changePasswordForm);
      fetch('{% url "settings_change_password" %}', { method: 'POST', body: fd, headers: { 'X-CSRFToken': csrf } })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (d.status === 'success') { showToast(d.message); changePasswordForm.reset(); }
          else showToast(d.message || 'Error');
        })
        .catch(function() { showToast('Request failed'); });
    });
  }

  var themeSwitchAppearance = document.getElementById('themeSwitchAppearance');
  if (themeSwitchAppearance) {
    themeSwitchAppearance.addEventListener('change', function() {
      var theme = this.checked ? 'dark' : 'light';
      document.body.classList.remove('theme-light', 'theme-dark');
      document.body.classList.add('theme-' + theme);
      document.querySelectorAll('[data-theme-toggle]').forEach(function(b) {
        var il = b.querySelector('.theme-icon-light');
        var id = b.querySelector('.theme-icon-dark');
        if (il) il.style.display = theme === 'dark' ? 'inline-block' : 'none';
        if (id) id.style.display = theme === 'light' ? 'inline-block' : 'none';
      });
      var fd = new FormData();
      fd.append('theme', theme);
      fd.append('csrfmiddlewaretoken', csrf);
      fetch('{% url "theme_save" %}', { method: 'POST', body: fd })
        .then(function(r) { return r.json(); })
        .then(function(d) { if (d.status === 'success') showToast('Theme saved.'); });
    });
  }
})();
</script>
{% endblock %}
