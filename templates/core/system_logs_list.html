{% extends "base.html" %}
{% load static %}

{% block title %}System Logs{% endblock %}

{% block content %}
<h1 class="mb-4" style="background: var(--soul-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
  System Logs
</h1>
<p class="text-muted mb-4">Unified observability: events, errors, and API interactions. Click a row to view full details.</p>

<form method="get" class="card-soul mb-3 p-3 d-flex gap-3 flex-wrap align-items-end">
  <div>
    <label class="form-label small mb-0">Category</label>
    <select name="category" class="form-select form-select-sm" style="width:auto">
      <option value="">All</option>
      {% for v, l in category_choices %}<option value="{{ v }}" {% if filters.category == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
    </select>
  </div>
  <div>
    <label class="form-label small mb-0">Level</label>
    <select name="level" class="form-select form-select-sm" style="width:auto">
      <option value="">All</option>
      {% for v, l in level_choices %}<option value="{{ v }}" {% if filters.level == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
    </select>
  </div>
  <div>
    <label class="form-label small mb-0">Status Code</label>
    <input type="text" name="status_code" class="form-control form-control-sm" placeholder="e.g. 500" value="{{ filters.status_code }}" style="width:100px">
  </div>
  <div>
    <label class="form-label small mb-0">From Date</label>
    <input type="date" name="date_from" class="form-control form-control-sm" value="{{ filters.date_from }}" style="width:140px">
  </div>
  <div>
    <label class="form-label small mb-0">To Date</label>
    <input type="date" name="date_to" class="form-control form-control-sm" value="{{ filters.date_to }}" style="width:140px">
  </div>
  <button type="submit" class="btn btn-sm btn-soul">Filter</button>
</form>

<div class="card-soul">
  <div class="table-responsive">
    <table class="table table-soul table-hover mb-0">
      <thead>
        <tr>
          <th>Time</th>
          <th>Category</th>
          <th>Level</th>
          <th>Message</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for log in page_obj %}
        <tr class="system-log-row {% if log.level == 'ERROR' or log.level == 'CRITICAL' %}table-danger{% elif log.level == 'WARNING' %}table-warning{% elif log.status_code and log.status_code < 300 %}table-success{% endif %}" role="button" data-href="{% url 'system_log_detail' log.pk %}">
          <td class="text-nowrap">{{ log.created_at|date:"Y-m-d H:i:s" }}</td>
          <td>{{ log.get_category_display }}</td>
          <td>
            <span class="badge {% if log.level == 'ERROR' or log.level == 'CRITICAL' %}bg-danger{% elif log.level == 'WARNING' %}bg-warning text-dark{% else %}bg-success{% endif %}">{{ log.level }}</span>
          </td>
          <td class="text-truncate" style="max-width:400px">{{ log.message|truncatechars:80 }}</td>
          <td>{% if log.status_code %}{{ log.status_code }}{% else %}â€”{% endif %}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-muted">No system logs.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% if page_obj.has_other_pages %}
<nav class="mt-3"><ul class="pagination pagination-sm">
  {% if page_obj.has_previous %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if filters.category %}&category={{ filters.category }}{% endif %}{% if filters.level %}&level={{ filters.level }}{% endif %}{% if filters.status_code %}&status_code={{ filters.status_code }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">Previous</a></li>{% endif %}
  <li class="page-item disabled"><span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
  {% if page_obj.has_next %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if filters.category %}&category={{ filters.category }}{% endif %}{% if filters.level %}&level={{ filters.level }}{% endif %}{% if filters.status_code %}&status_code={{ filters.status_code }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">Next</a></li>{% endif %}
</ul></nav>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.system-log-row[data-href]').forEach(function(row) {
  row.style.cursor = 'pointer';
  row.addEventListener('click', function() { window.location.href = this.getAttribute('data-href'); });
});
</script>
{% endblock %}
