{% extends "base.html" %}
{% load static %}

{% block title %}Manual Template Editor — {{ template.name }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb breadcrumb-soul mb-0">
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="{% url 'template_tester' %}">Template Manager</a></li>
    <li class="breadcrumb-item active" aria-current="page">Manual Editor — {{ template.name }}</li>
  </ol>
</nav>
{% endblock %}

{% block extra_css %}
<style>
.manual-workspace {
  background: var(--bg-body);
  border-radius: 12px;
}
.manual-grid {
  display: grid;
  grid-template-columns: minmax(360px, 40%) minmax(0, 60%);
  gap: 1rem;
}
.control-panel {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  box-shadow: var(--shadow-sm);
  max-height: calc(100vh - 210px);
  overflow: auto;
  padding: 1rem;
}
.preview-panel {
  position: sticky;
  top: 1rem;
  align-self: start;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  box-shadow: var(--shadow-sm);
  padding: 1rem;
}
.preview-toolbar {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: .75rem;
  align-items: center;
  margin-bottom: .8rem;
}
.preview-stage {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: auto;
  background: #0f172a;
  max-height: 74vh;
}
#liveCanvas {
  display: block;
  max-width: none;
}
.layer-controls .accordion-item {
  border: 1px solid var(--border-color);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: .6rem;
  background: var(--bg-card);
}
.layer-controls .accordion-button {
  background: var(--bg-card);
  color: var(--text-primary);
  font-weight: 600;
}
.layer-controls .accordion-button:not(.collapsed) {
  color: var(--text-primary);
  background: rgba(59, 130, 246, 0.08);
}
.layer-controls .form-label {
  color: var(--text-primary);
  font-size: .85rem;
  margin-bottom: .3rem;
}
.layer-controls .form-control,
.layer-controls .form-select {
  border-color: var(--border-color);
  border-radius: 6px;
}
.input-step-wrap {
  display: grid;
  grid-template-columns: minmax(0, 1fr) auto auto;
  gap: .25rem;
}
.step-btn {
  width: 2rem;
  border: 1px solid var(--border-color);
  background: var(--bg-body);
  color: var(--text-primary);
  border-radius: 6px;
  line-height: 1;
}
.coord-warn {
  border-color: #f59e0b !important;
  box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.25) !important;
}
.sticky-save-footer {
  position: sticky;
  bottom: 0;
  margin-top: .8rem;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: .75rem;
  box-shadow: 0 -4px 18px rgba(0, 0, 0, 0.1);
  z-index: 9;
}
.status-box {
  margin-top: .75rem;
}
@media (max-width: 1100px) {
  .manual-grid { grid-template-columns: 1fr; }
  .preview-panel { position: static; }
}
</style>
{% endblock %}

{% block content %}
<section class="manual-workspace">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h1 class="mb-1" style="color: var(--text-primary); font-weight: 600;">High-Precision Manual Editor</h1>
      <p class="text-muted mb-0">{{ template.name }} — Numeric control with zero-latency live canvas preview.</p>
    </div>
    <a href="{% url 'template_tester' %}" class="btn btn-outline-secondary">Back to Template Manager</a>
  </div>

  <div class="manual-grid">
    <form id="manualEditorForm" class="control-panel">
      {% csrf_token %}
      <input type="hidden" name="action" id="formAction" value="save">
      <input type="hidden" name="preview_category" id="preview_category_hidden" value="">
      <input type="hidden" name="preview_description" id="preview_description_hidden" value="">
      <input type="hidden" name="preview_phone" id="preview_phone_hidden" value="">
      <input type="hidden" name="preview_price" id="preview_price_hidden" value="">

      <div class="mb-3">
        <h5 style="color: var(--text-primary); font-weight: 600;">Preview Content</h5>
        <p class="text-muted small mb-2">This is test-only content for live preview; it does not overwrite real ads.</p>
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label">Category (Farsi)</label>
            <input type="text" id="preview_category" class="form-control preview-content-input" value="فروش ویژه" dir="rtl">
          </div>
          <div class="col-12">
            <label class="form-label">Description (Farsi)</label>
            <textarea id="preview_description" class="form-control preview-content-input" rows="3" dir="rtl">این یک متن نمونه برای پیش‌نمایش زنده است. موقعیت و اندازه را به‌صورت عددی تنظیم کنید.</textarea>
          </div>
          <div class="col-6">
            <label class="form-label">Phone</label>
            <input type="text" id="preview_phone" class="form-control preview-content-input" value="09123456789">
          </div>
          <div class="col-6">
            <label class="form-label">Price</label>
            <input type="text" id="preview_price" class="form-control preview-content-input" value="۱۲,۰۰۰,۰۰۰ تومان" dir="rtl">
          </div>
        </div>
      </div>

      <div class="mb-3 d-flex flex-wrap align-items-end gap-2">
        <div>
          <label class="form-label">Apply Source Layer to All</label>
          <select class="form-select" id="applySourceLayer">
            <option value="cat">Category</option>
            <option value="desc">Description</option>
            <option value="phone">Phone</option>
            <option value="price">Price</option>
          </select>
        </div>
        <button type="button" class="btn btn-outline-primary" id="btnApplyToAll">Apply to All</button>
        <button type="button" class="btn btn-outline-warning" id="btnResetDefaults">Reset to Defaults</button>
      </div>

      <div class="layer-controls accordion" id="layerAccordion">
        {% with c=cat d=desc p=phone_coord pr=price_coord %}
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#layerCategory">Category Layer</button>
          </h2>
          <div id="layerCategory" class="accordion-collapse collapse show">
            <div class="accordion-body">
              {% include "core/partials/layer_controls.html" with prefix="cat" title="Category" x=c.x|default:0 y=c.y|default:0 size=c.size|default:48 color=c.color|default:"#FFFFFF" max_width=c.max_width|default:700 align=c.align|default:"right" %}
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#layerDescription">Description Layer</button>
          </h2>
          <div id="layerDescription" class="accordion-collapse collapse">
            <div class="accordion-body">
              {% include "core/partials/layer_controls.html" with prefix="desc" title="Description" x=d.x|default:0 y=d.y|default:0 size=d.size|default:32 color=d.color|default:"#FFFFFF" max_width=d.max_width|default:800 align=d.align|default:"right" %}
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#layerPhone">Phone Layer</button>
          </h2>
          <div id="layerPhone" class="accordion-collapse collapse">
            <div class="accordion-body">
              {% include "core/partials/layer_controls.html" with prefix="phone" title="Phone" x=p.x|default:0 y=p.y|default:0 size=p.size|default:28 color=p.color|default:"#FFFF00" max_width=p.max_width|default:550 align=p.align|default:"right" %}
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#layerPrice">Price Layer</button>
          </h2>
          <div id="layerPrice" class="accordion-collapse collapse">
            <div class="accordion-body">
              {% include "core/partials/layer_controls.html" with prefix="price" title="Price" x=pr.x|default:0 y=pr.y|default:0 size=pr.size|default:30 color=pr.color|default:"#00E5FF" max_width=pr.max_width|default:550 align=pr.align|default:"right" %}
            </div>
          </div>
        </div>
        {% endwith %}
      </div>

      <div class="sticky-save-footer">
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
          <span class="small text-muted">Tip: use <code>Shift + Arrow</code> in numeric inputs for 10px jumps.</span>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" id="btnSave">Save Changes</button>
            <button type="button" class="btn btn-outline-secondary" id="btnSaveTest">Save + Test Render</button>
          </div>
        </div>
      </div>

      <div class="status-box">
        <div id="saveStatus" class="alert alert-success d-none mb-0"></div>
        <div id="errorStatus" class="alert alert-danger d-none mb-0"></div>
      </div>
    </form>

    <aside class="preview-panel">
      <div class="preview-toolbar">
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="gridToggle">
          <label class="form-check-label" for="gridToggle">Grid Overlay (100px)</label>
        </div>
        <div style="min-width: 180px;">
          <label class="form-label mb-1">Zoom <span id="zoomLabel">100%</span></label>
          <input type="range" class="form-range" id="zoomRange" min="50" max="200" step="10" value="100">
        </div>
      </div>

      <div class="preview-stage">
        {% if background_url %}
        <canvas id="liveCanvas" width="{{ img_width }}" height="{{ img_height }}"></canvas>
        {% else %}
        <p class="text-muted p-3 mb-0">No background image is available for this template.</p>
        {% endif %}
      </div>
      <p class="small text-muted mt-2 mb-0">Canvas: {{ img_width }} × {{ img_height }} px</p>

      <div id="testImageResult" class="mt-3 d-none">
        <h6 style="color: var(--text-primary);">Server Test Image</h6>
        <img id="testImage" alt="Test image" style="max-width: 100%; border-radius: 8px; border: 1px solid var(--border-color);">
      </div>
    </aside>
  </div>
</section>

{% if background_url %}
<img id="bgSource" src="{{ background_url }}" alt="Background source" style="display:none;">
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
(function() {
  var form = document.getElementById('manualEditorForm');
  var canvas = document.getElementById('liveCanvas');
  var bgImg = document.getElementById('bgSource');
  var csrf = document.querySelector('#manualEditorForm [name=csrfmiddlewaretoken]') ? document.querySelector('#manualEditorForm [name=csrfmiddlewaretoken]').value : '';
  var imgW = {{ img_width }};
  var imgH = {{ img_height }};
  var rafId = null;

  var defaults = {{ default_coords|safe }};

  function byId(id) { return document.getElementById(id); }
  function getLayer(prefix) {
    return {
      x: parseFloat((byId(prefix + '_x') || {}).value || 0),
      y: parseFloat((byId(prefix + '_y') || {}).value || 0),
      size: parseFloat((byId(prefix + '_size') || {}).value || 24),
      color: ((byId(prefix + '_color_hex') || {}).value || '#FFFFFF').trim(),
      maxWidth: parseFloat((byId(prefix + '_max_width') || {}).value || imgW),
      align: ((byId(prefix + '_align') || {}).value || 'right').toLowerCase()
    };
  }
  function setLayer(prefix, cfg) {
    if (byId(prefix + '_x')) byId(prefix + '_x').value = cfg.x;
    if (byId(prefix + '_y')) byId(prefix + '_y').value = cfg.y;
    if (byId(prefix + '_size')) byId(prefix + '_size').value = cfg.size;
    if (byId(prefix + '_color_hex')) byId(prefix + '_color_hex').value = cfg.color;
    if (byId(prefix + '_color_picker')) byId(prefix + '_color_picker').value = cfg.color;
    if (byId(prefix + '_max_width')) byId(prefix + '_max_width').value = cfg.maxWidth;
    if (byId(prefix + '_align')) byId(prefix + '_align').value = cfg.align;
  }

  function wrapRtlText(ctx, text, maxWidth, fontPx) {
    if (!text) return [];
    var lines = [];
    var paragraphs = String(text).split('\n');
    paragraphs.forEach(function(par) {
      if (!par.trim()) { lines.push(''); return; }
      var words = par.split(/\s+/);
      var current = '';
      words.forEach(function(w) {
        var candidate = current ? (current + ' ' + w) : w;
        var m = ctx.measureText(candidate).width;
        if (m <= maxWidth || !current) {
          current = candidate;
        } else {
          lines.push(current);
          current = w;
        }
      });
      if (current) lines.push(current);
    });
    return lines;
  }

  function drawLayer(ctx, cfg, text, isMultiLine) {
    if (!text) return;
    var safeSize = Number.isFinite(cfg.size) ? Math.max(1, cfg.size) : 24;
    var safeX = Number.isFinite(cfg.x) ? cfg.x : 0;
    var safeY = Number.isFinite(cfg.y) ? cfg.y : 0;
    var safeMax = Number.isFinite(cfg.maxWidth) ? Math.max(1, cfg.maxWidth) : imgW;
    var align = (cfg.align === 'left' || cfg.align === 'center' || cfg.align === 'right') ? cfg.align : 'right';
    var color = /^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/.test(cfg.color || '') ? cfg.color : '#FFFFFF';

    ctx.font = safeSize + 'px VazirFallback, Vazirmatn, Vazir, Samim, Tahoma, sans-serif';
    ctx.fillStyle = color;
    ctx.textBaseline = 'top';
    ctx.direction = 'rtl';
    ctx.textAlign = align === 'center' ? 'center' : (align === 'left' ? 'left' : 'right');

    if (!isMultiLine) {
      var anchorX = align === 'center' ? (safeX + safeMax / 2) : (align === 'left' ? (safeX + safeMax) : safeX);
      ctx.fillText(text, anchorX, safeY, safeMax);
      return;
    }

    var lines = wrapRtlText(ctx, text, safeMax, safeSize);
    var lineHeight = Math.round(safeSize * 1.35);
    var y = safeY;
    for (var i = 0; i < lines.length; i++) {
      var anchor = align === 'center' ? (safeX + safeMax / 2) : (align === 'left' ? (safeX + safeMax) : safeX);
      ctx.fillText(lines[i], anchor, y, safeMax);
      y += lineHeight;
    }
  }

  function applyWarnings() {
    var layers = ['cat', 'desc', 'phone', 'price'];
    layers.forEach(function(prefix) {
      var l = getLayer(prefix);
      var out = l.x < 0 || l.y < 0 || l.x > imgW || l.y > imgH;
      ['x', 'y', 'max_width'].forEach(function(field) {
        var input = byId(prefix + '_' + field);
        if (input) input.classList.toggle('coord-warn', out);
      });
    });
  }

  function renderCanvas() {
    if (!canvas || !bgImg) return;
    var ctx = canvas.getContext('2d');
    if (!ctx) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(bgImg, 0, 0, imgW, imgH);

    if (byId('gridToggle') && byId('gridToggle').checked) {
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.lineWidth = 1;
      for (var x = 100; x < imgW; x += 100) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, imgH); ctx.stroke();
      }
      for (var y = 100; y < imgH; y += 100) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(imgW, y); ctx.stroke();
      }
      ctx.restore();
    }

    drawLayer(ctx, getLayer('cat'), (byId('preview_category') || {}).value || '', false);
    drawLayer(ctx, getLayer('desc'), (byId('preview_description') || {}).value || '', true);
    drawLayer(ctx, getLayer('phone'), (byId('preview_phone') || {}).value || '', false);
    drawLayer(ctx, getLayer('price'), (byId('preview_price') || {}).value || '', false);

    applyWarnings();
  }

  function queueRender() {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(renderCanvas);
  }

  function syncPreviewHiddenFields() {
    if (byId('preview_category_hidden')) byId('preview_category_hidden').value = (byId('preview_category') || {}).value || '';
    if (byId('preview_description_hidden')) byId('preview_description_hidden').value = (byId('preview_description') || {}).value || '';
    if (byId('preview_phone_hidden')) byId('preview_phone_hidden').value = (byId('preview_phone') || {}).value || '';
    if (byId('preview_price_hidden')) byId('preview_price_hidden').value = (byId('preview_price') || {}).value || '';
  }

  function bindColorSync(prefix) {
    var hex = byId(prefix + '_color_hex');
    var picker = byId(prefix + '_color_picker');
    if (!hex || !picker) return;
    hex.addEventListener('input', function() {
      if (/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/.test(hex.value)) picker.value = hex.value;
      queueRender();
    });
    picker.addEventListener('input', function() {
      hex.value = picker.value;
      queueRender();
    });
  }

  function bindStepButtons() {
    document.querySelectorAll('.step-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var target = byId(btn.getAttribute('data-target'));
        var step = parseInt(btn.getAttribute('data-step') || '1', 10);
        if (!target) return;
        var v = parseInt(target.value || '0', 10);
        if (btn.getAttribute('data-dir') === 'down') v -= step; else v += step;
        target.value = v;
        queueRender();
      });
    });
  }

  function bindKeyboardJump() {
    document.querySelectorAll('input[type="number"]').forEach(function(inp) {
      inp.addEventListener('keydown', function(e) {
        if (!e.shiftKey || (e.key !== 'ArrowUp' && e.key !== 'ArrowDown')) return;
        e.preventDefault();
        var v = parseInt(inp.value || '0', 10);
        inp.value = v + (e.key === 'ArrowUp' ? 10 : -10);
        queueRender();
      });
    });
  }

  function showStatus(type, msg) {
    var ok = byId('saveStatus');
    var err = byId('errorStatus');
    if (ok) ok.classList.add('d-none');
    if (err) err.classList.add('d-none');
    var el = type === 'success' ? ok : err;
    if (!el) return;
    el.textContent = msg;
    el.classList.remove('d-none');
  }

  function submitForm(action) {
    if (!form) return;
    byId('formAction').value = action;
    syncPreviewHiddenFields();
    var fd = new FormData(form);
    fetch('{% url "template_manual_edit" template.pk %}', {
      method: 'POST',
      body: fd,
      headers: { 'X-CSRFToken': csrf }
    })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.status === 'success') {
          showStatus('success', data.message || 'Saved.');
          if (data.test_image_url && byId('testImage')) {
            byId('testImage').src = data.test_image_url;
            if (byId('testImageResult')) byId('testImageResult').classList.remove('d-none');
          }
        } else {
          showStatus('error', (data.errors && data.errors.join(', ')) || data.message || 'Save failed.');
        }
      })
      .catch(function() { showStatus('error', 'Request failed.'); });
  }

  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      submitForm('save');
    });
  }
  if (byId('btnSaveTest')) byId('btnSaveTest').addEventListener('click', function() { submitForm('save_test'); });

  if (byId('btnApplyToAll')) {
    byId('btnApplyToAll').addEventListener('click', function() {
      var src = (byId('applySourceLayer') || {}).value || 'cat';
      var cfg = getLayer(src);
      ['cat', 'desc', 'phone', 'price'].forEach(function(prefix) {
        if (prefix === src) return;
        setLayer(prefix, cfg);
      });
      queueRender();
    });
  }

  if (byId('btnResetDefaults')) {
    byId('btnResetDefaults').addEventListener('click', function() {
      setLayer('cat', {
        x: defaults.category.x || 0, y: defaults.category.y || 0, size: defaults.category.size || 48,
        color: defaults.category.color || '#FFFFFF', maxWidth: defaults.category.max_width || 700, align: defaults.category.align || 'right'
      });
      setLayer('desc', {
        x: defaults.description.x || 0, y: defaults.description.y || 0, size: defaults.description.size || 32,
        color: defaults.description.color || '#FFFFFF', maxWidth: defaults.description.max_width || 800, align: defaults.description.align || 'right'
      });
      setLayer('phone', {
        x: defaults.phone.x || 0, y: defaults.phone.y || 0, size: defaults.phone.size || 28,
        color: defaults.phone.color || '#FFFF00', maxWidth: defaults.phone.max_width || 550, align: defaults.phone.align || 'right'
      });
      setLayer('price', {
        x: defaults.price.x || 0, y: defaults.price.y || 0, size: defaults.price.size || 30,
        color: defaults.price.color || '#00E5FF', maxWidth: defaults.price.max_width || 550, align: defaults.price.align || 'right'
      });
      queueRender();
    });
  }

  if (byId('zoomRange') && canvas) {
    byId('zoomRange').addEventListener('input', function() {
      var zoom = parseInt(byId('zoomRange').value || '100', 10);
      canvas.style.width = Math.round((imgW * zoom) / 100) + 'px';
      canvas.style.height = Math.round((imgH * zoom) / 100) + 'px';
      if (byId('zoomLabel')) byId('zoomLabel').textContent = zoom + '%';
      queueRender();
    });
  }

  ['cat', 'desc', 'phone', 'price'].forEach(bindColorSync);
  bindStepButtons();
  bindKeyboardJump();

  document.querySelectorAll('input, select, textarea').forEach(function(el) {
    if (el.id === 'formAction') return;
    el.addEventListener('input', function() { syncPreviewHiddenFields(); queueRender(); });
    el.addEventListener('change', function() { syncPreviewHiddenFields(); queueRender(); });
  });

  if (bgImg) {
    if (bgImg.complete) {
      syncPreviewHiddenFields();
      queueRender();
    } else {
      bgImg.addEventListener('load', function() {
        syncPreviewHiddenFields();
        queueRender();
      });
    }
  }
})();
</script>
{% endblock %}
