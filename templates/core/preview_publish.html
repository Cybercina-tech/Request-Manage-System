{% extends "base.html" %}
{% load static %}
{# Final Preview & Publish: generated image, Instagram/Telegram preview, Confirm & Distribute. #}

{% block title %}Preview & Publish — {{ ad.uuid }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb breadcrumb-soul mb-0">
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ad_list' %}">Requests</a></li>
    <li class="breadcrumb-item"><a href="{% url 'ad_detail' ad.uuid %}">Request {{ ad.uuid|truncatechars:8 }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">Preview & Publish</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
  <h1 class="mb-0" style="background: var(--soul-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
    Final Preview & Publish
  </h1>
  <a href="{% url 'ad_detail' ad.uuid %}" class="btn btn-outline-secondary">
    <i class="fa-solid fa-arrow-left icon" aria-hidden="true"></i> Back to Request
  </a>
</div>

<div class="row g-4">
  <div class="col-lg-6">
    <div class="card-soul h-100">
      <h5 class="text-muted mb-3"><i class="fa-solid fa-image icon" aria-hidden="true"></i> Generated image</h5>
      <div id="previewImageWrap" class="bg-dark rounded d-flex align-items-center justify-content-center min-vh-25 position-relative">
        {% if preview_image_url %}
        <img id="previewImg" src="{{ preview_image_url }}" alt="Ad preview" class="img-fluid rounded loading-hide" style="max-height: 70vh;">
        <div id="previewLoading" class="position-absolute top-50 start-50 translate-middle text-muted">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading…</span></div>
          <p class="mt-2 small mb-0">Generating image…</p>
        </div>
        {% else %}
        <p class="text-warning mb-0 py-4">Image could not be generated. Check template and coordinates.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card-soul mb-4">
      <h5 class="text-muted mb-3"><i class="fa-brands fa-instagram icon" aria-hidden="true"></i> Instagram caption</h5>
      <div class="bg-dark border border-secondary rounded p-3 small" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap;">{{ caption_preview|default:"—" }}</div>
    </div>
    <div class="card-soul mb-4">
      <h5 class="text-muted mb-3"><i class="fa-brands fa-telegram icon" aria-hidden="true"></i> Telegram message</h5>
      {% if default_channel %}
      <p class="small text-muted mb-2">Will be sent to: <strong>{{ default_channel.title }}</strong></p>
      {% endif %}
      <div class="bg-dark border border-secondary rounded p-3 small" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap;">{{ telegram_preview|default:"—" }}</div>
    </div>
    <form method="post" action="{% url 'preview_publish' ad.uuid %}" id="distributeForm">
      {% csrf_token %}
      <button type="submit" class="btn btn-soul btn-lg w-100" id="btnDistribute">
        <i class="fa-solid fa-paper-plane icon me-2" aria-hidden="true"></i>
        Confirm & Distribute
      </button>
    </form>
    <p class="text-muted small mt-2 mb-0">Sends to Telegram channel and publishes to Instagram Feed + Story.</p>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.min-vh-25 { min-height: 200px; }
.loading-hide { opacity: 0; transition: opacity 0.3s ease; }
.loading-hide.loaded { opacity: 1; }
#previewImg.loaded ~ #previewLoading { display: none !important; }
</style>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  var img = document.getElementById('previewImg');
  var loading = document.getElementById('previewLoading');
  var form = document.getElementById('distributeForm');
  var btn = document.getElementById('btnDistribute');

  if (img) {
    if (img.complete && img.naturalWidth) {
      img.classList.add('loaded');
      if (loading) loading.style.display = 'none';
    } else {
      img.addEventListener('load', function() { img.classList.add('loaded'); if (loading) loading.style.display = 'none'; });
      img.addEventListener('error', function() { if (loading) { loading.innerHTML = '<p class="text-danger mb-0">Failed to load image</p>'; } });
    }
  }

  if (form && btn) {
    form.addEventListener('submit', function() {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span> Distributing…';
    });
  }
})();
</script>
{% endblock %}
