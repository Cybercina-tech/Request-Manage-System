{% extends "base.html" %}
{% load static %}
{# Category Management — Midnight Obsidian theme #}

{% block title %}Categories{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
  <h1 class="mb-0" style="background: var(--soul-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
    Categories
  </h1>
  <a href="{% url 'category_create' %}" class="btn btn-soul">
    <i class="fa-solid fa-plus icon" aria-hidden="true"></i> Add New Category
  </a>
</div>

<p class="text-muted mb-4">Manage ad categories. Active categories appear in the Telegram bot and filters.</p>

<div class="card-soul">
  <div class="table-responsive">
    <table class="table table-soul table-hover mb-0">
      <thead>
        <tr>
          <th>Name</th>
          <th>نام فارسی</th>
          <th>Slug</th>
          <th style="width: 100px">Color</th>
          <th>Status</th>
          <th style="width: 160px">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for cat in categories %}
        <tr data-category-id="{{ cat.pk }}">
          <td class="align-middle">{{ cat.name }}</td>
          <td class="align-middle" dir="rtl" style="font-family: 'Vazir','VazirFallback','Tahoma',sans-serif;">{{ cat.name_fa|default:"—" }}</td>
          <td class="align-middle"><code>{{ cat.slug }}</code></td>
          <td class="align-middle">
            <span class="badge badge-cat-dynamic" style="--cat-color: {{ cat.color }};">{{ cat.color }}</span>
          </td>
          <td class="align-middle">
            <span class="badge {% if cat.is_active %}bg-success{% else %}bg-secondary{% endif %}">{{ cat.is_active|yesno:"Active,Inactive" }}</span>
          </td>
          <td class="align-middle">
            <button type="button" class="btn btn-sm btn-action me-1 category-toggle" data-pk="{{ cat.pk }}" data-active="{{ cat.is_active|yesno:"true,false" }}" title="Toggle active">
              <i class="fa-solid fa-power-off icon" aria-hidden="true"></i>
            </button>
            <a href="{% url 'category_edit' cat.pk %}" class="btn btn-sm btn-gold me-1" title="Edit">
              <i class="fa-solid fa-pen icon" aria-hidden="true"></i>
            </a>
            <button type="button" class="btn btn-sm btn-hot category-delete" data-pk="{{ cat.pk }}" data-name="{{ cat.name }}" title="Delete">
              <i class="fa-solid fa-trash icon" aria-hidden="true"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted py-4">No categories yet. Add one to get started.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function() {
  document.querySelectorAll('.category-toggle').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var pk = this.getAttribute('data-pk');
      fetch('{% url "category_toggle" 0 %}'.replace('/0/', '/' + pk + '/'), {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
      })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.status === 'success') window.location.reload();
      });
    });
  });

  document.querySelectorAll('.category-delete').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (!confirm('Delete category "' + this.getAttribute('data-name') + '"? Ads will be moved to Other.')) return;
      var pk = this.getAttribute('data-pk');
      fetch('{% url "category_delete" 0 %}'.replace('/0/', '/' + pk + '/'), {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
      })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.status === 'success') window.location.href = d.redirect;
      });
    });
  });
})();
</script>
{% endblock %}
