{% extends "base.html" %}
{% load static %}
{# Category Management â€” Midnight Obsidian theme #}

{% block title %}Categories{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
  <h1 class="mb-0" style="background: var(--soul-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
    Categories
  </h1>
  <button type="button" class="btn btn-soul" data-bs-toggle="modal" data-bs-target="#categoryModal" id="addCategoryBtn">
    <i class="fa-solid fa-plus icon" aria-hidden="true"></i> Add New Category
  </button>
</div>

<p class="text-muted mb-4">Manage ad categories. Active categories appear in the Telegram bot and filters.</p>

<div class="card-soul">
  <div class="table-responsive">
    <table class="table table-soul table-hover mb-0">
      <thead>
        <tr>
          <th>Name</th>
          <th>Slug</th>
          <th style="width: 100px">Color</th>
          <th>Status</th>
          <th style="width: 160px">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for cat in categories %}
        <tr data-category-id="{{ cat.pk }}">
          <td class="align-middle">{{ cat.name }}</td>
          <td class="align-middle"><code>{{ cat.slug }}</code></td>
          <td class="align-middle">
            <span class="badge badge-cat-dynamic" style="--cat-color: {{ cat.color }};">{{ cat.color }}</span>
          </td>
          <td class="align-middle">
            <span class="badge {% if cat.is_active %}bg-success{% else %}bg-secondary{% endif %}">{{ cat.is_active|yesno:"Active,Inactive" }}</span>
          </td>
          <td class="align-middle">
            <button type="button" class="btn btn-sm btn-action me-1 category-toggle" data-pk="{{ cat.pk }}" data-active="{{ cat.is_active|yesno:"true,false" }}" title="Toggle active">
              <i class="fa-solid fa-power-off icon" aria-hidden="true"></i>
            </button>
            <a href="{% url 'category_edit' cat.pk %}" class="btn btn-sm btn-gold me-1" title="Edit">
              <i class="fa-solid fa-pen icon" aria-hidden="true"></i>
            </a>
            <button type="button" class="btn btn-sm btn-hot category-delete" data-pk="{{ cat.pk }}" data-name="{{ cat.name }}" title="Delete">
              <i class="fa-solid fa-trash icon" aria-hidden="true"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center text-muted py-4">No categories yet. Add one to get started.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# Add/Edit Modal #}
<div class="modal modal-soul fade" id="categoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="categoryModalLabel">Add Category</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="categoryForm">
        <div class="modal-body">
          {% csrf_token %}
          <input type="hidden" name="pk" id="categoryPk" value="">
          <div class="mb-3">
            <label class="form-label">Name <span class="text-danger">*</span></label>
            <input type="text" name="name" class="form-control" required placeholder="e.g. Real Estate">
          </div>
          <div class="mb-3">
            <label class="form-label">Slug</label>
            <input type="text" name="slug" class="form-control" placeholder="Auto-generated from name">
          </div>
          <div class="mb-3">
            <label class="form-label">Color</label>
            <div class="d-flex align-items-center gap-2">
              <input type="color" name="color" id="categoryColor" value="#7C4DFF" class="form-control form-control-color" style="width: 60px; height: 38px;">
              <input type="text" name="color_text" id="categoryColorText" value="#7C4DFF" class="form-control" placeholder="#7C4DFF">
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Icon (optional)</label>
            <input type="text" name="icon" class="form-control" placeholder="e.g. home">
          </div>
          <div class="mb-3">
            <label class="form-label">Order</label>
            <input type="number" name="order" class="form-control" value="0" min="0">
          </div>
          <div class="form-check form-switch">
            <input type="checkbox" name="is_active" class="form-check-input" id="categoryActive" checked>
            <label class="form-check-label" for="categoryActive">Active</label>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-soul">
            <i class="fa-solid fa-check icon" aria-hidden="true"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  var modal = document.getElementById('categoryModal');
  var form = document.getElementById('categoryForm');
  var addBtn = document.getElementById('addCategoryBtn');
  var colorInput = document.getElementById('categoryColor');
  var colorText = document.getElementById('categoryColorText');

  function syncColor() {
    var c = colorInput.value;
    colorText.value = c;
    form.querySelector('input[name="color"]') && (form.querySelector('input[name="color"]').value = c);
  }
  colorInput && colorInput.addEventListener('input', syncColor);
  colorText && colorText.addEventListener('input', function() {
    if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) colorInput.value = this.value;
  });

  addBtn && addBtn.addEventListener('click', function() {
    form.reset();
    document.getElementById('categoryPk').value = '';
    document.getElementById('categoryModalLabel').textContent = 'Add Category';
    document.getElementById('categoryColor').value = '#7C4DFF';
    document.getElementById('categoryColorText').value = '#7C4DFF';
    document.getElementById('categoryActive').checked = true;
  });

  form && form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (colorText && /^#[0-9A-Fa-f]{6}$/.test(colorText.value)) colorInput.value = colorText.value;
    var fd = new FormData(form);
    fd.set('color', colorInput ? colorInput.value : '#7C4DFF');
    fd.delete('color_text');
    var pk = document.getElementById('categoryPk').value;
    var url = pk ? '{% url "category_edit" 0 %}'.replace('/0/', '/' + pk + '/') : '{% url "category_create" %}';
    fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
      body: fd,
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (d.status === 'success') window.location.href = d.redirect;
      else alert(d.message || 'Error');
    })
    .catch(function() { alert('Request failed'); });
  });

  document.querySelectorAll('.category-toggle').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var pk = this.getAttribute('data-pk');
      fetch('{% url "category_toggle" 0 %}'.replace('/0/', '/' + pk + '/'), {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
      })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.status === 'success') window.location.reload();
      });
    });
  });

  document.querySelectorAll('.category-delete').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (!confirm('Delete category "' + this.getAttribute('data-name') + '"? Ads will be moved to Other.')) return;
      var pk = this.getAttribute('data-pk');
      fetch('{% url "category_delete" 0 %}'.replace('/0/', '/' + pk + '/'), {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
      })
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.status === 'success') window.location.href = d.redirect;
      });
    });
  });
})();
</script>
{% endblock %}
