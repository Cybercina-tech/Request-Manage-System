{% extends "base.html" %}
{% load static %}

{% block title %}{% if is_create %}Add API client{% else %}Edit {{ client.name }}{% endif %}{% endblock %}

{% block content %}
<h1 class="mb-4" style="background: var(--soul-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
  {% if is_create %}Add API client{% else %}Edit {{ client.name }}{% endif %}
</h1>

<form id="apiForm" class="form-soul card-soul" style="max-width: 480px;" action="{% if is_create %}{% url 'settings_api_create' %}{% else %}{% url 'settings_api_edit' client.pk %}{% endif %}" method="post">
  {% csrf_token %}
  <div class="mb-3">
    <label class="form-label">Name</label>
    <input type="text" class="form-control" name="name" required value="{% if client %}{{ client.name }}{% endif %}" placeholder="Partner name">
  </div>
  <div class="mb-3">
    <label class="form-label">Rate limit (requests per minute)</label>
    <input type="number" class="form-control" name="rate_limit_per_min" min="1" max="1000" value="{% if client %}{{ client.rate_limit_per_min }}{% else %}60{% endif %}">
  </div>
  {% if not is_create %}
  <div class="mb-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" name="regenerate_key" id="regenerate_key">
      <label class="form-check-label" for="regenerate_key">Regenerate API key (old key will stop working)</label>
    </div>
  </div>
  {% endif %}
  <div class="mb-3">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" name="is_active" {% if not client or client.is_active %}checked{% endif %}>
      <label class="form-check-label">Active</label>
    </div>
  </div>
  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-soul">{% if is_create %}Create{% else %}Save{% endif %}</button>
    <a href="{% url 'settings_api' %}" class="btn btn-outline-secondary">Cancel</a>
  </div>
</form>
<div id="formResult" class="mt-2 small"></div>
<div id="newKeyModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">API key (copy now)</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-warning small">This key will not be shown again. Store it securely.</p>
        <input type="text" class="form-control font-monospace" id="newKeyValue" readonly>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('apiForm').addEventListener('submit', function(e) {
  e.preventDefault();
  var resultEl = document.getElementById('formResult');
  resultEl.textContent = '';
  fetch(this.action, { method: 'POST', headers: { 'X-CSRFToken': csrfToken }, body: new FormData(this) })
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (d.status === 'success') {
        if (d.new_key) {
          var modalEl = document.getElementById('newKeyModal');
          document.getElementById('newKeyValue').value = d.new_key;
          bootstrap.Modal.getOrCreateInstance(modalEl).show();
          modalEl.addEventListener('hidden.bs.modal', function() { window.location.href = d.redirect; }, { once: true });
        } else {
          resultEl.className = 'mt-2 small text-success'; resultEl.textContent = 'Saved.';
          if (d.redirect) window.location.href = d.redirect;
        }
      } else { resultEl.className = 'mt-2 small text-danger'; resultEl.textContent = d.message || 'Error'; }
    })
    .catch(function() { resultEl.className = 'mt-2 small text-danger'; resultEl.textContent = 'Request failed'; });
});
</script>
{% endblock %}
